# 自动化内容平台架构设计文档

> 版本：v1.0
> 更新日期：2025-12-11

---

## 一、项目概述

### 1.1 项目目标

构建一个完整的自动化内容处理平台，实现从内容监控、下载、创作到发布的全流程自动化。

### 1.2 核心业务流程

```
监控账号 → 定时检测新作品 → 下载素材 → 自动创作 → 自动发布
```

### 1.3 设计原则

- **渐进式开发**：先跑通核心链路，再逐步完善
- **模块化设计**：各模块独立，通过任务系统串联
- **可扩展性**：支持多平台、多业务线扩展
- **最小可行性**：避免过度设计，以功能实现为优先

---

## 二、功能模块分析

### 2.1 基础模块

| 模块         | 职责                         | 优先级 |
| ------------ | ---------------------------- | ------ |
| 监控模块     | 监控指定平台账号，检测新作品 | P0     |
| 下载模块     | 下载视频/图片素材到本地      | P0     |
| 创作模块     | 调用剪映自动生成视频         | P0     |
| 发布模块     | 自动上传到目标平台           | P1     |
| 任务模块     | 任务调度、状态管理、日志记录 | P0     |
| 浏览器自动化 | Playwright/比特浏览器封装    | P0     |

### 2.2 功能补充建议

#### 监控模块补充

- 作品去重机制（基于 `original_id` 避免重复处理）
- 监控频率配置（不同账号可设置不同检测间隔）
- 监控状态通知（可选，后期扩展）

#### 下载模块补充

- 下载队列管理（控制并发，避免被封）
- 下载失败重试机制（最大重试次数配置）
- 素材元数据存储（标题、描述、标签等）

#### 创作模块补充

- 创作模板管理（不同内容类型使用不同模板）
- 创作参数配置（字幕样式、背景音乐等）
- 与 `pyJianYingDraft` 深度集成

#### 发布模块补充

- 多平台账号管理
- 发布时间策略（定时发布、错峰发布）
- 发布状态追踪

#### 任务模块补充

- 流水线定义（将多个步骤串联）
- 任务状态机（pending → running → success/failed）
- 失败任务的人工介入机制

---

## 三、项目结构设计

### 3.1 目录结构

```
app/
├── core/                    # 核心配置（已有）
│   ├── config.py            # 全局配置
│   ├── events.py            # 应用事件
│   ├── exceptions.py        # 异常定义
│   ├── logging.py           # 日志配置
│   └── middleware.py        # 中间件
│
├── db/                      # 数据库配置（已有）
│
├── models/                  # 数据模型
│   ├── account/             # 账号相关（已有）
│   ├── monitor/             # 监控相关（已有）
│   │   ├── monitor_config.py
│   │   └── monitor_daily_stats.py
│   ├── content/             # 内容相关（新增）
│   │   ├── source_content.py    # 源内容（下载的素材）
│   │   └── created_content.py   # 创作内容（生成的作品）
│   ├── task/                # 任务相关（新增）
│   │   ├── task.py              # 任务主表
│   │   ├── task_log.py          # 任务日志
│   │   └── pipeline.py          # 流水线定义
│   └── publish/             # 发布相关（新增）
│       ├── publish_account.py   # 发布账号
│       └── publish_record.py    # 发布记录
│
├── services/                # 业务逻辑
│   ├── account/             # 账号服务（已有）
│   ├── monitor/             # 监控服务（已有）
│   │   ├── monitor_service.py
│   │   ├── browser_service.py
│   │   └── task_service.py
│   ├── downloader/          # 下载服务（新增）
│   │   └── downloader_service.py
│   ├── creator/             # 创作服务（新增）
│   │   └── creator_service.py
│   ├── publisher/           # 发布服务（新增）
│   │   └── publisher_service.py
│   └── pipeline/            # 流水线服务（新增）
│       └── pipeline_service.py
│
├── workers/                 # 后台任务执行器（新增）
│   ├── base_worker.py       # Worker 基类
│   ├── scheduler.py         # 定时任务调度器
│   ├── monitor_worker.py    # 监控执行器
│   ├── download_worker.py   # 下载执行器
│   ├── create_worker.py     # 创作执行器
│   └── publish_worker.py    # 发布执行器
│
├── adapters/                # 平台适配器（新增）
│   ├── base.py              # 适配器基类
│   ├── platforms/           # 各平台实现
│   │   ├── douyin.py        # 抖音适配器
│   │   ├── kuaishou.py      # 快手适配器
│   │   └── xiaohongshu.py   # 小红书适配器
│   └── browser/             # 浏览器自动化
│       └── bit_browser.py   # 比特浏览器封装
│
├── routers/                 # API 路由（已有）
│   ├── account/
│   ├── monitor/
│   ├── system/
│   ├── task/                # 任务相关路由（新增）
│   └── pipeline/            # 流水线相关路由（新增）
│
├── schemas/                 # Pydantic 模式（已有）
│
├── repositories/            # 数据仓储（已有）
│
├── util/                    # 工具类（已有）
│   ├── jianying_util.py     # 剪映工具
│   ├── Playwright_util.py   # 浏览器自动化
│   └── ...
│
└── main.py                  # 应用入口
```

### 3.2 模块依赖关系

```
┌─────────────────────────────────────────────────────────────┐
│                        API Layer (routers)                  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     Service Layer (services)                │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │
│  │ Monitor  │ │Downloader│ │ Creator  │ │Publisher │       │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │
│                      │                                      │
│              ┌───────┴───────┐                              │
│              │   Pipeline    │  ← 流水线编排                │
│              └───────────────┘                              │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    Worker Layer (workers)                   │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │
│  │ Monitor  │ │ Download │ │  Create  │ │ Publish  │       │
│  │ Worker   │ │ Worker   │ │  Worker  │ │ Worker   │       │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │
│                      │                                      │
│              ┌───────┴───────┐                              │
│              │  Scheduler    │  ← 定时调度                  │
│              └───────────────┘                              │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   Adapter Layer (adapters)                  │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │
│  │  抖音    │ │  快手    │ │ 小红书   │ │ 比特浏览器│       │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    Data Layer (models)                      │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │
│  │ Monitor  │ │ Content  │ │  Task    │ │ Publish  │       │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │
└─────────────────────────────────────────────────────────────┘
```

---

## 四、核心数据模型设计

### 4.1 源内容表（source_content）

记录从监控账号下载的原始素材。

```python
class SourceContent(BaseModel):
    """源内容模型 - 下载的素材"""

    id: int                      # 主键
    user_id: int                 # 所属用户
    monitor_config_id: int       # 关联监控配置

    # 来源信息
    platform: str                # 来源平台（douyin/kuaishou/xiaohongshu）
    original_id: str             # 原始作品ID（用于去重）
    original_url: str            # 原始链接
    author_id: str               # 原作者ID
    author_name: str             # 原作者名称

    # 内容信息
    title: str                   # 标题
    description: str             # 描述
    tags: JSON                   # 标签列表

    # 本地存储
    video_path: str              # 视频本地路径
    cover_path: str              # 封面本地路径

    # 元数据
    duration: int                # 视频时长（秒）
    width: int                   # 视频宽度
    height: int                  # 视频高度

    # 状态
    status: str                  # pending/downloaded/processing/processed/failed

    # 时间戳
    published_at: datetime       # 原作品发布时间
    created_at: datetime
    updated_at: datetime
```

### 4.2 创作内容表（created_content）

记录通过剪映创作生成的作品。

```python
class CreatedContent(BaseModel):
    """创作内容模型 - 生成的作品"""

    id: int                      # 主键
    user_id: int                 # 所属用户
    source_content_id: int       # 关联源内容（可为空，支持原创）

    # 创作信息
    template_id: int             # 使用的模板ID
    draft_name: str              # 剪映草稿名称
    draft_path: str              # 草稿路径

    # 输出信息
    output_path: str             # 导出视频路径
    title: str                   # 作品标题
    description: str             # 作品描述
    tags: JSON                   # 标签列表

    # 状态
    status: str                  # pending/creating/created/exported/failed

    # 时间戳
    created_at: datetime
    updated_at: datetime
```

### 4.3 任务表（task）

统一的任务管理表。

```python
class Task(BaseModel):
    """任务模型"""

    id: int                      # 主键
    user_id: int                 # 所属用户
    pipeline_id: int             # 关联流水线（可为空）

    # 任务信息
    task_type: str               # monitor/download/create/publish
    task_name: str               # 任务名称

    # 关联数据
    source_content_id: int       # 关联源内容
    created_content_id: int      # 关联创作内容

    # 执行信息
    status: str                  # pending/running/success/failed/cancelled
    priority: int                # 优先级（数字越大优先级越高）
    retry_count: int             # 已重试次数
    max_retry: int               # 最大重试次数

    # 错误信息
    error_message: str           # 错误信息
    error_stack: str             # 错误堆栈

    # 时间戳
    scheduled_at: datetime       # 计划执行时间
    started_at: datetime         # 开始执行时间
    finished_at: datetime        # 完成时间
    created_at: datetime
    updated_at: datetime
```

### 4.4 流水线表（pipeline）

定义自动化流水线。

```python
class Pipeline(BaseModel):
    """流水线模型"""

    id: int                      # 主键
    user_id: int                 # 所属用户

    # 基本信息
    name: str                    # 流水线名称
    description: str             # 描述

    # 配置
    config: JSON                 # 流水线配置（步骤、参数等）
    # 示例配置：
    # {
    #     "steps": ["monitor", "download", "create", "publish"],
    #     "monitor_config_id": 1,
    #     "template_id": 1,
    #     "publish_account_ids": [1, 2]
    # }

    # 调度
    is_active: bool              # 是否启用
    cron_expression: str         # 定时表达式（如 "0 */30 * * *" 每30分钟）

    # 时间戳
    last_run_at: datetime        # 上次执行时间
    created_at: datetime
    updated_at: datetime
```

### 4.5 发布账号表（publish_account）

管理发布目标平台的账号。

```python
class PublishAccount(BaseModel):
    """发布账号模型"""

    id: int                      # 主键
    user_id: int                 # 所属用户

    # 账号信息
    platform: str                # 平台（douyin/kuaishou/xiaohongshu）
    account_name: str            # 账号名称
    account_id: str              # 平台账号ID

    # 浏览器配置
    browser_id: str              # 比特浏览器窗口ID

    # 状态
    is_active: bool              # 是否启用
    last_publish_at: datetime    # 上次发布时间

    # 时间戳
    created_at: datetime
    updated_at: datetime
```

---

## 五、执行流程设计

### 5.1 完整流水线执行流程

```
┌─────────────┐
│  Scheduler  │  定时触发（如每30分钟）
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  Pipeline   │  加载流水线配置
│  Service    │
└──────┬──────┘
       │
       ▼
┌─────────────┐     ┌─────────────────────────────────┐
│  Monitor    │────▶│ 1. 获取监控配置                  │
│  Worker     │     │ 2. 访问目标账号页面              │
│             │     │ 3. 解析作品列表                  │
│             │     │ 4. 对比已有记录，筛选新作品      │
│             │     │ 5. 创建 SourceContent 记录       │
│             │     │ 6. 创建下载任务                  │
└──────┬──────┘     └─────────────────────────────────┘
       │
       ▼
┌─────────────┐     ┌─────────────────────────────────┐
│  Download   │────▶│ 1. 获取待下载任务                │
│  Worker     │     │ 2. 下载视频到本地                │
│             │     │ 3. 更新 SourceContent 状态       │
│             │     │ 4. 创建创作任务                  │
└──────┬──────┘     └─────────────────────────────────┘
       │
       ▼
┌─────────────┐     ┌─────────────────────────────────┐
│  Create     │────▶│ 1. 获取待创作任务                │
│  Worker     │     │ 2. 加载剪映模板                  │
│             │     │ 3. 替换素材、生成草稿            │
│             │     │ 4. 调用剪映导出视频              │
│             │     │ 5. 创建 CreatedContent 记录      │
│             │     │ 6. 创建发布任务                  │
└──────┬──────┘     └─────────────────────────────────┘
       │
       ▼
┌─────────────┐     ┌─────────────────────────────────┐
│  Publish    │────▶│ 1. 获取待发布任务                │
│  Worker     │     │ 2. 打开比特浏览器窗口            │
│             │     │ 3. 自动化上传视频                │
│             │     │ 4. 填写标题、描述、标签          │
│             │     │ 5. 提交发布                      │
│             │     │ 6. 更新发布状态                  │
└─────────────┘     └─────────────────────────────────┘
```

### 5.2 任务状态机

```
                    ┌─────────┐
                    │ pending │  任务创建
                    └────┬────┘
                         │
            ┌────────────┼────────────┐
            │            │            │
            ▼            ▼            ▼
      ┌─────────┐  ┌─────────┐  ┌─────────┐
      │ running │  │cancelled│  │ timeout │
      └────┬────┘  └─────────┘  └─────────┘
           │
     ┌─────┴─────┐
     │           │
     ▼           ▼
┌─────────┐ ┌─────────┐
│ success │ │ failed  │──┐
└─────────┘ └────┬────┘  │
                 │       │ retry_count < max_retry
                 │       │
                 └───────┴──▶ pending（重试）
```

---

## 六、技术选型

| 功能         | 方案                    | 理由                        |
| ------------ | ----------------------- | --------------------------- |
| Web 框架     | FastAPI（已有）         | 异步、高性能、自动文档      |
| ORM          | TortoiseORM（已有）     | 异步 ORM，与 FastAPI 配合好 |
| 数据库       | MySQL（已有）           | 稳定可靠                    |
| 定时任务     | APScheduler             | 轻量，Python 原生           |
| 任务队列     | 数据库轮询（初期）      | 简单，避免引入 Redis        |
| 浏览器自动化 | Playwright（已有）      | 现代、稳定                  |
| 视频创作     | pyJianYingDraft（已有） | 已集成                      |
| 多窗口管理   | 比特浏览器（已有）      | 支持多账号隔离              |

---

## 七、实施计划

### 第一阶段：核心链路（1-2 周）

**目标**：跑通 监控 → 下载 → 创作 的基本流程

- [ ] 完善监控模块，实现新作品检测
- [ ] 实现下载模块，支持视频下载到本地
- [ ] 对接剪映创作，利用 `pyJianYingDraft` 生成视频
- [ ] 创建基础任务表，记录任务状态

### 第二阶段：任务系统（1 周）

**目标**：完善任务调度和状态管理

- [ ] 实现任务状态机
- [ ] 添加失败重试机制
- [ ] 实现简单的定时调度（APScheduler）
- [ ] 添加任务日志记录

### 第三阶段：发布能力（1-2 周）

**目标**：实现自动发布功能

- [ ] 发布账号管理
- [ ] 单平台发布实现（先做抖音）
- [ ] 发布状态追踪

### 第四阶段：扩展优化

**目标**：完善和扩展

- [ ] 多平台适配（快手、小红书）
- [ ] 流水线可视化配置
- [ ] 数据统计面板
- [ ] 通知机制（微信/邮件）

---

## 八、配置扩展

在 `app/core/config.py` 中需要添加的配置：

```python
# 下载配置
DOWNLOAD_BASE_PATH: str = "./downloads"      # 下载文件存储路径
DOWNLOAD_MAX_CONCURRENT: int = 3             # 最大并发下载数
DOWNLOAD_MAX_RETRY: int = 3                  # 下载最大重试次数

# 创作配置
JIANYING_DRAFT_FOLDER: str = ""              # 剪映草稿文件夹（已有）
JIANYING_EXPORT_PATH: str = "./exports"      # 导出视频存储路径
TEMPLATE_BASE_PATH: str = "./templates"      # 模板存储路径

# 发布配置
PUBLISH_INTERVAL_SECONDS: int = 300          # 发布间隔（秒）

# 任务配置
TASK_MAX_RETRY: int = 3                      # 任务最大重试次数
TASK_POLL_INTERVAL: int = 10                 # 任务轮询间隔（秒）

# 调度配置
SCHEDULER_ENABLED: bool = True               # 是否启用调度器
MONITOR_CRON: str = "*/30 * * * *"           # 监控定时表达式（每30分钟）
```

---

## 九、与现有代码的集成

### 9.1 已有资源

根据现有项目结构，以下资源可以直接复用：

- `app/services/monitor/` - 监控服务基础框架
- `app/util/jianying_util.py` - 剪映工具类
- `app/util/Playwright_util.py` - 浏览器自动化工具
- `pyJianYingDraft/` - 剪映草稿操作库
- `app/core/config.py` - 配置管理（已有比特浏览器配置）

### 9.2 需要新增的依赖

```toml
# pyproject.toml 中添加
dependencies = [
    # ... 已有依赖
    "apscheduler>=3.10.0",       # 定时任务调度
    "yt-dlp>=2024.0.0",          # 视频下载（可选）
]
```

---

## 十、总结

本设计文档提供了一个**渐进式、模块化**的自动化内容平台架构方案。核心思路是：

1. **先跑通核心链路**，验证可行性
2. **逐步完善任务系统**，提高稳定性
3. **扩展发布能力**，实现完整闭环
4. **持续优化扩展**，支持更多平台和场景

建议从**下载模块**开始实现，因为监控模块已有基础，下载是串联整个流程的关键一环。
