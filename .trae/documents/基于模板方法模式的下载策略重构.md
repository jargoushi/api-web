# 基于模板方法模式的下载策略重构 - 最终方案

## 1. 第三方库GitHub地址

### 1.1 Douyin-Downloader
- GitHub地址：https://gitcode.com/GitHub_Trending/do/douyin-downloader
- 描述：功能强大的抖音内容下载工具，支持批量获取视频、图集、合集和原声音频，并自动去除水印

### 1.2 yt-dlp
- GitHub地址：https://github.com/yt-dlp/yt-dlp
- 描述：先进的命令行音频/视频下载器，支持700+网站，包括YouTube、B站等

## 2. 调整后的设计方案

### 2.1 核心设计调整
根据用户反馈，简化模板方法设计，只保留必要步骤：

- 移除URL验证：已通过策略选择验证URL
- 移除下载格式选择：统一使用MP4格式
- 合并下载请求和下载逻辑：由子类统一实现
- 移除清理资源：无必要资源需要清理
- 预留数据库记录接口：添加保存下载记录的抽象方法

### 2.2 类结构设计

```
├── BaseDownloadStrategy（抽象基类）
│   ├── download（模板方法，定义完整流程）
│   ├── _init_download（初始化）
│   ├── _get_video_info（抽象方法，获取视频信息）
│   ├── _execute_download（抽象方法，执行下载）
│   ├── _save_video_file（保存视频文件）
│   ├── _save_download_record（抽象方法，预留数据库记录接口）
│   └── _handle_completion（完成处理）
├── DouyinStrategy（抖音策略）
│   └── 实现抽象方法
└── YoutubeStrategy（YouTube策略）
    └── 实现抽象方法
```

### 2.3 模板方法执行顺序

```
1. 调用 _init_download() 初始化下载环境
2. 调用 _get_video_info() 获取视频信息
3. 调用 _execute_download() 执行下载
4. 调用 _save_video_file() 保存视频文件
5. 调用 _save_download_record() 保存下载记录（预留接口）
6. 调用 _handle_completion() 处理完成逻辑
7. 返回最终文件路径
```

## 3. 详细实现设计

### 3.1 重构 `BaseDownloadStrategy` 基类

```python
class BaseDownloadStrategy(ABC):
    """下载策略基类，实现模板方法模式"""
    
    def __init__(self):
        self.download_info = {}
        self.video_info = {}
    
    @final
    async def download(self, url: str) -> str:
        """模板方法，定义完整下载流程"""
        # 1. 初始化下载
        await self._init_download(url)
        
        # 2. 获取视频信息
        self.video_info = await self._get_video_info(url)
        
        # 3. 执行下载
        download_result = await self._execute_download(url, self.video_info)
        
        # 4. 保存视频文件
        file_path = await self._save_video_file(download_result)
        
        # 5. 保存下载记录（预留数据库接口）
        await self._save_download_record(url, self.video_info, file_path)
        
        # 6. 处理完成逻辑
        final_path = await self._handle_completion(file_path)
        
        return final_path
    
    async def _init_download(self, url: str) -> None:
        """初始化下载环境"""
        # 初始化下载信息
        self.download_info = {
            "url": url,
            "start_time": datetime.now(),
            "status": "pending"
        }
    
    @abstractmethod
    async def _get_video_info(self, url: str) -> dict:
        """获取视频信息，由子类实现"""
        pass
    
    @abstractmethod
    async def _execute_download(self, url: str, video_info: dict) -> Any:
        """执行下载，由子类实现"""
        pass
    
    async def _save_video_file(self, download_result: Any) -> str:
        """保存视频文件"""
        # 生成唯一文件名
        filename = f"{int(time.time())}_{uuid.uuid4().hex[:8]}.mp4"
        file_path = os.path.join(settings.DOWNLOAD_DIR, filename)
        
        # 确保下载目录存在
        os.makedirs(settings.DOWNLOAD_DIR, exist_ok=True)
        
        # 保存文件逻辑（根据download_result类型处理）
        if isinstance(download_result, bytes):
            # 直接写入字节流
            with open(file_path, 'wb') as f:
                f.write(download_result)
        elif isinstance(download_result, str) and os.path.exists(download_result):
            # 移动临时文件
            shutil.move(download_result, file_path)
        else:
            # 其他类型处理
            raise BusinessException(message="不支持的下载结果类型")
        
        return file_path
    
    @abstractmethod
    async def _save_download_record(self, url: str, video_info: dict, file_path: str) -> None:
        """保存下载记录（预留数据库接口），由子类实现"""
        # 此方法用于将下载记录保存到数据库
        # 子类可以选择实现或留空
        pass
    
    async def _handle_completion(self, file_path: str) -> str:
        """处理完成逻辑"""
        # 更新下载状态
        self.download_info.update({
            "status": "completed",
            "end_time": datetime.now(),
            "file_path": file_path,
            "size": os.path.getsize(file_path)
        })
        
        return file_path
```

### 3.2 抖音策略实现

```python
class DouyinStrategy(BaseDownloadStrategy):
    """抖音下载策略"""
    
    url_patterns = ["douyin.com", "iesdouyin.com"]
    
    async def _get_video_info(self, url: str) -> dict:
        """获取抖音视频信息"""
        from douyin_downloader import DouyinClient
        client = DouyinClient()
        return await client.get_video_info(url)
    
    async def _execute_download(self, url: str, video_info: dict) -> Any:
        """执行抖音视频下载"""
        from douyin_downloader import DouyinClient
        client = DouyinClient()
        # 使用抖音下载器下载视频，返回临时文件路径
        return await client.download_video(url)
    
    async def _save_download_record(self, url: str, video_info: dict, file_path: str) -> None:
        """保存抖音下载记录（预留接口）"""
        # TODO: 实现数据库记录保存
        pass
```

### 3.3 YouTube策略实现

```python
class YoutubeStrategy(BaseDownloadStrategy):
    """YouTube下载策略"""
    
    url_patterns = ["youtube.com", "youtu.be"]
    
    async def _get_video_info(self, url: str) -> dict:
        """获取YouTube视频信息"""
        import yt_dlp
        ydl_opts = {
            'quiet': True,
            'no_warnings': True,
        }
        with yt_dlp.YoutubeDL(ydl_opts) as ydl:
            return ydl.extract_info(url, download=False)
    
    async def _execute_download(self, url: str, video_info: dict) -> Any:
        """执行YouTube视频下载"""
        import yt_dlp
        
        # 设置下载选项，只下载MP4格式
        ydl_opts = {
            'format': 'bestvideo[ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]/best',
            'outtmpl': '/tmp/%(id)s.%(ext)s',
            'quiet': True,
            'no_warnings': True,
        }
        
        with yt_dlp.YoutubeDL(ydl_opts) as ydl:
            info_dict = ydl.extract_info(url, download=True)
            # 返回下载的文件路径
            return ydl.prepare_filename(info_dict)
    
    async def _save_download_record(self, url: str, video_info: dict, file_path: str) -> None:
        """保存YouTube下载记录（预留接口）"""
        # TODO: 实现数据库记录保存
        pass
```

## 4. 实现优势

1. **简化设计**：只保留必要步骤，降低复杂度
2. **代码复用**：公共下载逻辑集中在基类
3. **扩展性强**：新增下载平台只需实现抽象方法
4. **接口兼容**：保持原有API不变
5. **预留扩展点**：支持后续添加数据库记录功能
6. **统一管理**：下载流程由基类统一管理，确保一致性

## 5. 实施计划

1. 安装依赖库：`pip install douyin-downloader yt-dlp`
2. 重构 `BaseDownloadStrategy` 基类，实现模板方法
3. 更新 `DouyinStrategy`，实现抖音特定逻辑
4. 更新 `YoutubeStrategy`，实现YouTube特定逻辑
5. 测试下载功能，确保正常工作
6. 保持原有接口兼容，无需修改其他文件

## 6. 预期效果

- 保持原有API不变，无需修改调用代码
- 下载流程统一管理，便于后续扩展
- 支持抖音和YouTube视频下载
- 预留数据库记录接口，便于后续功能扩展
- 代码结构清晰，易于维护和扩展