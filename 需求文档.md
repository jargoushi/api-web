# 视频内容自动化制作项目：需求文档 (PRD)

### 一、项目目标与背景

| **字段**     | **描述**                                                     |
| ------------ | ------------------------------------------------------------ |
| **项目名称** | 地理信息驱动的方言视频批量生成系统 (Geo-Dialect Video Generator) |
| **项目目标** | 实现基于 GeoJSON 地图数据和结构化内容的视频全自动化生成，输出 CapCut/剪映（`pyJianYingDraft`）兼容的工程文件。 |
| **最终效果** | 生成的视频应包含地图高亮、同步音频播放、实时字幕和镜头推拉效果，与用户提供的视频效果相似。 |
| **关键约束** | **100% 自动化**生成工程文件（即无需手动拖拽对齐），视频分辨率为 **1080x1920 (竖屏)**。 |

### 二、系统功能需求

#### 2.1 核心数据结构 (Input Specification)

系统应依赖一个主要的 **JSON 脚本文件** 来驱动所有内容，确保所有信息都可配置。

| **JSON 字段**             | **描述**                                             | **示例值**                             |
| ------------------------- | ---------------------------------------------------- | -------------------------------------- |
| `video_title`             | 视频标题（用于开场字幕）。                           | "安徽哪里的姑娘说话最温柔？"           |
| `base_map_path`           | 全省地图底图文件的相对路径。                         | `assets/images/base_map_satellite.png` |
| `scenes`                  | 场景列表（主循环体），每个元素对应一个城市展示片段。 | `[...]`                                |
| `scenes[].city_name`      | 地理信息对应的城市名称。                             | "合肥市"                               |
| `scenes[].pinyin`         | 城市拼音（建议用于生成文件命名）。                   | "hefei"                                |
| `scenes[].audio_path`     | 方言音频文件的相对路径。                             | `assets/audio/hefei.mp3`               |
| `scenes[].subtitle_text`  | 视频中显示的字幕内容。                               | "我们合肥小大姐都长在花里的..."        |
| `scenes[].highlight_path` | 对应城市的高亮 PNG 素材路径。                        | `assets/images/hefei_highlight.png`    |

#### 2.2 素材生成模块 (Asset Generator - Python)

**需求：** 必须基于 GeoJSON 数据，自动生成高分辨率、透明背景的城市高亮图层。

| **功能点**              | **描述**                                                     | **实现技术**                                |
| ----------------------- | ------------------------------------------------------------ | ------------------------------------------- |
| **底图生成**            | 生成一张全省的静态底图（如卫星图风格，带边框）。             | `Geopandas` + `Matplotlib`                  |
| **高亮图层生成**        | **循环** GeoJSON 数据，为每个行政区生成一张 **全尺寸画布、背景透明** 的 PNG 图片，仅目标区域高亮显示。 | `Geopandas` + `Matplotlib`                  |
| **定位数据导出 (关键)** | 自动计算每个城市多边形的 **中心坐标 (Centroid)** 和 **外接矩形 (Bounds)**，并以 JSON 格式导出，用于运镜模块。 | `Geopandas` (利用 `.centroid` 和 `.bounds`) |
| **时长获取**            | 自动读取所有音频文件的精确时长，并更新到 JSON 脚本中。       | `Mutagen` 或 `pydub`                        |

#### 2.3 视频组装模块 (Draft Builder - Python + pyJianYingDraft)

**需求：** 使用 `pyJianYingDraft` 库，根据 JSON 脚本创建多轨道、时间精确对齐的剪映工程文件。

| **轨道名称**           | **内容**                                                     | **需求/特效**                                                |
| ---------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **轨道 0 (背景)**      | 底图 (`base_map_path`)。                                     | 持续时长为所有场景时长的总和。                               |
| **轨道 1 (音频)**      | 串联所有音频文件 (`audio_path`)。                            | 精确对齐到毫秒，无缝衔接。                                   |
| **轨道 2 (高亮)**      | 串联所有城市高亮图 (`highlight_path`)。                      | 每个片段的 **开始时间** 必须与对应音频的开始时间一致，**时长** 与音频时长一致。 |
| **轨道 3 (字幕)**      | 串联所有字幕文本 (`subtitle_text`)。                         | 需配置字体、大小、颜色、描边等样式，与高亮片段同步。         |
| **轨道 4 (贴纸/图标)** | （可选）小喇叭或城市名标签。                                 | 与高亮片段同步，位置固定。                                   |
| **运镜 (核心)**        | 对 **轨道 0 (背景)** 或 **复合片段** 应用关键帧 (Keyframes)。 | **实现目标**：在每个场景的开始点，画面从全省地图 **平滑过渡/缩放** 到当前城市中心。 |

### 三、技术实现细节 (Technical Specification)

#### 3.1 关键帧与运镜自动化 (最难点)

由于 `pyJianYingDraft` 对 Keyframe 的支持可能不够完善或文档复杂，这是全自动化的最大挑战。

- **解决方案：** 利用 Geopandas 计算出的 **中心点 (x, y)** 和 **外接矩形**，反推出在 1080x1920 画布上的 **缩放比例 (scale)** 和 **平移量 (translate)**。

- **实现逻辑：**

  1. 计算当前城市外接矩形边界，确定需要将画面放大到能覆盖该边界的最小缩放比例 $S$。
  2. 计算该城市中心点 $C_{map}$ 在画布上的目标中心点 $C_{canvas}$。
  3. 将 $S$ 和 $C_{canvas}$ 转化为剪映工程文件中的 `transform.scale` 和 `transform.position` 属性。
  4. 为每个场景的开头和结尾添加 **两个关键帧**：
     - **K1 (过渡开始)**：使用上一个城市的运镜参数或全省参数。
     - **K2 (过渡结束)**：使用当前城市的目标运镜参数 ($S$, $C_{canvas}$)。

  - **要求：** 必须在 `pyJianYingDraft` 中找到添加 **位置** 和 **缩放** 关键帧的 API，否则无法实现全自动化运镜。

#### 3.2 文件与路径规范

- 所有素材路径在 JSON 中必须是**绝对路径**，以确保剪映能正确读取。
- Python 脚本必须处理文件路径的转义和 OS 兼容性。

#### 3.3 容错处理

- 如果音频文件缺失，系统应跳过该场景并记录日志，而不是崩溃。
- 如果 GeoJSON 数据中的城市名与配置 JSON 中的城市名不匹配，系统应抛出错误。

------

### 四、测试与验收标准

| **标准**       | **描述**                                                     |
| -------------- | ------------------------------------------------------------ |
| **功能性测试** | 成功生成可被剪映专业版打开的 `.json` 草稿文件。              |
| **时间轴测试** | 所有音频、高亮图、字幕的时间轴对齐误差 **小于 50ms**。       |
| **视觉效果**   | 地图高亮层无错位，准确覆盖行政区划。                         |
| **运镜效果**   | 画面切换时有平滑的缩放和移动，准确聚焦到当前城市，无突兀跳帧。 |